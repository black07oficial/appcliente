/**
 * üß™ Script de Teste Real de Comunica√ß√£o - KingPay
 * ================================================
 * 
 * Testa a comunica√ß√£o REAL com os 39 endpoints essenciais para a funcionalidade do App.
 * Esta lista foi curada e definida como a base funcional em 23/07/2025.
 * 
 * Execute: npm run test:real
 */

const { createClient } = require('@supabase/supabase-js');
require('dotenv').config();

// Configura√ß√µes reais do Supabase
const supabaseUrl = process.env.EXPO_PUBLIC_SUPABASE_URL;
const supabaseAnonKey = process.env.EXPO_PUBLIC_SUPABASE_ANON_KEY;

// Mock do storage em mem√≥ria para o Supabase
const memoryStorage = {};

const supabase = createClient(supabaseUrl, supabaseAnonKey, {
  auth: {
    storage: {
      getItem: (key) => memoryStorage[key] || null,
      setItem: (key, value) => { memoryStorage[key] = value; },
      removeItem: (key) => { delete memoryStorage[key]; },
    },
    autoRefreshToken: true,
    persistSession: true,
    detectSessionInUrl: false,
  }
});

// Credenciais reais para teste
const TEST_CREDENTIALS = {
  email: 'matheuss.devv@gmail.com',
  password: '88338391Mt@'
};

console.log('üöÄ Iniciando teste REAL de comunica√ß√£o do KingPay (Endpoints Funcionais)...\n');

// Verificar configura√ß√£o
if (!supabaseUrl || !supabaseAnonKey) {
  console.error('‚ùå Erro: Vari√°veis de ambiente n√£o configuradas!');
  process.exit(1);
}

console.log(`‚úÖ URL: ${supabaseUrl}`);
console.log(`‚úÖ Chave configurada: ${supabaseAnonKey.substring(0, 50)}...`);
console.log(`‚úÖ Email de teste: ${TEST_CREDENTIALS.email}\n`);

// Lista dos 39 endpoints essenciais e funcionais
const functionalEndpoints = [
  // ========== AUTENTICA√á√ÉO E SESS√ÉO ==========
  {
    category: 'Autentica√ß√£o',
    name: 'Login Real',
    type: 'auth',
    method: 'POST',
    endpoint: 'signInWithPassword',
    description: 'Login com credenciais reais',
    requiresAuth: false,
    priority: 'critical'
  },
  {
    category: 'Autentica√ß√£o',
    name: 'Obter Usu√°rio Logado',
    type: 'auth',
    method: 'GET',
    endpoint: 'getUser',
    description: 'Obt√©m dados do usu√°rio logado',
    requiresAuth: true,
    priority: 'high'
  },
  
  // ========== DASHBOARD E RELAT√ìRIOS ==========
  {
    category: 'Dashboard',
    name: 'Dados do Dashboard',
    type: 'edge-function',
    method: 'POST',
    endpoint: 'dados-dashboard',
    description: 'Carrega dados reais do dashboard',
    requiresAuth: true,
    priority: 'high',
    payload: {} // Payload ser√° adicionado dinamicamente com as datas
  },
  {
    category: 'Dashboard',
    name: 'Dados do Gr√°fico do Dashboard',
    type: 'edge-function',
    method: 'POST',
    endpoint: 'dados-dashboard/grafico',
    description: 'Carrega dados para o gr√°fico do dashboard',
    requiresAuth: true,
    priority: 'high',
    payload: {}
  },
  {
    category: 'Dashboard',
    name: 'Top Produtos do Dashboard',
    type: 'edge-function',
    method: 'POST',
    endpoint: 'dados-dashboard/top-produtos',
    description: 'Busca os produtos mais vendidos',
    requiresAuth: true,
    priority: 'medium',
    payload: {}
  },
  {
    category: 'Dashboard',
    name: 'Infos Adicionais do Dashboard',
    type: 'edge-function',
    method: 'POST',
    endpoint: 'dados-dashboard/infos-adicionais',
    description: 'Busca informa√ß√µes de m√©todos de pagamento e parcelas',
    requiresAuth: true,
    priority: 'medium',
    payload: {}
  },
  {
    category: 'Dashboard',
    name: 'Providers do Dashboard',
    type: 'edge-function',
    method: 'POST',
    endpoint: 'dados-dashboard/providers',
    description: 'Busca os providers com melhor desempenho',
    requiresAuth: true,
    priority: 'medium',
    payload: {}
  },
  {
    category: 'Dashboard',
    name: 'Acquirers do Dashboard',
    type: 'edge-function',
    method: 'POST',
    endpoint: 'dados-dashboard/acquirer',
    description: 'Busca os acquirers com melhor desempenho',
    requiresAuth: true,
    priority: 'medium',
    payload: {}
  },
  {
    category: 'Dashboard',
    name: 'Faturamento Whitelabel',
    type: 'edge-function',
    method: 'POST',
    endpoint: 'faturamento-whitelabel',
    description: 'Busca dados de faturamento para whitelabel',
    requiresAuth: true,
    priority: 'medium',
    payload: {}
  },
  {
    category: 'Dashboard',
    name: 'Financeiro Whitelabel',
    type: 'edge-function',
    method: 'POST',
    endpoint: 'whitelabel-financeiro',
    description: 'Obt√©m dados financeiros consolidados para o whitelabel (Admin)',
    requiresAuth: true,
    priority: 'medium',
    payload: {}
  },

  // ========== LISTAGENS GERAIS (LEITURA) ==========
  {
    category: 'Clientes',
    name: 'Listar Clientes',
    type: 'edge-function',
    method: 'GET',
    endpoint: 'clientes',
    description: 'Lista clientes reais do CRM',
    requiresAuth: true,
    priority: 'medium'
  },
  {
    category: 'Links',
    name: 'Links de Pagamento',
    type: 'edge-function',
    method: 'GET',
    endpoint: 'link-pagamentos',
    description: 'Lista links reais de pagamento',
    requiresAuth: true,
    priority: 'medium'
  },
  {
    category: 'PIX',
    name: 'Chaves PIX',
    type: 'edge-function',
    method: 'GET',
    endpoint: 'pix-key',
    description: 'Lista chaves PIX reais',
    requiresAuth: true,
    priority: 'high'
  },
  {
    category: 'Alertas',
    name: 'Listar Alertas',
    type: 'edge-function',
    method: 'GET',
    endpoint: 'alerts',
    description: 'Lista alertas reais do usu√°rio',
    requiresAuth: true,
    priority: 'medium'
  },
  {
    category: 'Empresas',
    name: 'Dados da Empresa',
    type: 'edge-function',
    method: 'GET',
    endpoint: 'companies',
    description: 'Lista empresas (ou dados da empresa do usu√°rio)',
    requiresAuth: true,
    priority: 'high'
  },
  {
    category: 'Transa√ß√µes',
    name: 'Hist√≥rico de Transa√ß√µes',
    type: 'edge-function',
    method: 'GET',
    endpoint: 'transacoes',
    description: 'Lista transa√ß√µes reais',
    requiresAuth: true,
    priority: 'medium'
  },
  {
    category: 'Transa√ß√µes',
    name: 'Resumo de Transa√ß√µes',
    type: 'edge-function',
    method: 'GET',
    endpoint: 'transacoes/resumo',
    description: 'Resumo real das transa√ß√µes',
    requiresAuth: true,
    priority: 'high'
  },
  {
    category: 'Extrato',
    name: 'Extrato da Carteira',
    type: 'edge-function',
    method: 'GET',
    endpoint: 'extrato/user-id', // Placeholder
    description: 'Extrato real da carteira',
    requiresAuth: true,
    priority: 'medium'
  },
  {
    category: 'Financeiro',
    name: 'Listar Saques (Admin)',
    type: 'edge-function',
    method: 'GET',
    endpoint: 'saques',
    description: 'Lista as solicita√ß√µes de saque (Admin)',
    requiresAuth: true,
    priority: 'medium'
  },
  {
    category: 'Financeiro',
    name: 'Listar Antecipa√ß√µes (Admin)',
    type: 'edge-function',
    method: 'GET',
    endpoint: 'antecipacoes/anticipations',
    description: 'Lista as solicita√ß√µes de antecipa√ß√£o (Admin)',
    requiresAuth: true,
    priority: 'medium'
  },
  {
    category: 'Usu√°rios',
    name: 'Listar Usu√°rios (Admin)',
    type: 'edge-function',
    method: 'GET',
    endpoint: 'users',
    description: 'Lista todos os usu√°rios (requer permiss√£o de admin)',
    requiresAuth: true,
    priority: 'medium'
  },
  {
    category: 'Faturas',
    name: 'Listar Faturas',
    type: 'edge-function',
    method: 'GET',
    endpoint: 'billings',
    description: 'Lista as faturas do usu√°rio logado',
    requiresAuth: true,
    priority: 'medium'
  },
  {
    category: 'Admin: BaaS',
    name: 'Listar Provedores BaaS',
    type: 'edge-function',
    method: 'GET',
    endpoint: 'baas',
    description: 'Lista os provedores de Banking as a Service (Admin)',
    requiresAuth: true,
    priority: 'medium'
  },
  {
    category: 'Admin: Adquirentes',
    name: 'Listar Adquirentes',
    type: 'edge-function',
    method: 'GET',
    endpoint: 'acquirers',
    description: 'Lista os adquirentes/gateways de pagamento (Admin)',
    requiresAuth: true,
    priority: 'medium'
  },
  {
    category: 'Admin: Logs',
    name: 'Listar Logs de Auditoria',
    type: 'edge-function',
    method: 'GET',
    endpoint: 'audit-log',
    description: 'Lista os logs de auditoria do sistema (Admin)',
    requiresAuth: true,
    priority: 'medium'
  },
  {
    category: 'Admin: Padr√µes',
    name: 'Listar Configura√ß√µes Padr√£o',
    type: 'edge-function',
    method: 'GET',
    endpoint: 'standard',
    description: 'Lista os templates de configura√ß√£o padr√£o (Admin)',
    requiresAuth: true,
    priority: 'medium'
  },

  // ========== A√á√ïES DE ESCRITA (POST/PATCH) ==========
  {
    category: 'C√≥digo de Seguran√ßa',
    name: 'Gerar C√≥digo de Seguran√ßa',
    type: 'edge-function',
    method: 'POST',
    endpoint: 'validation-codes/generate',
    description: 'Gera um c√≥digo de seguran√ßa para o usu√°rio logado',
    requiresAuth: true,
    priority: 'medium'
  },
  {
    category: 'C√≥digo de Seguran√ßa',
    name: 'Validar C√≥digo de Seguran√ßa (Inv√°lido)',
    type: 'edge-function',
    method: 'POST',
    endpoint: 'validation-codes/validate',
    description: 'Tenta validar um c√≥digo de seguran√ßa –∑–∞–≤–µ–¥–æ–º–æ inv√°lido',
    requiresAuth: true,
    priority: 'medium',
    payload: { code: '000000' }
  },
  {
    category: 'Suporte',
    name: 'Listar/Criar Tickets',
    type: 'edge-function',
    method: 'POST',
    endpoint: 'support-tickets',
    description: 'Endpoint para listar ou criar tickets de suporte',
    requiresAuth: true,
    priority: 'medium',
    payload: { action: 'list_tickets', payload: {} } // Teste default: listar
  },
  {
    category: 'Links',
    name: 'Criar Link de Pagamento',
    type: 'edge-function',
    method: 'POST',
    endpoint: 'link-pagamentos',
    description: 'Cria um novo link de pagamento',
    requiresAuth: true,
    priority: 'high',
    payload: { nome: 'Produto de Teste Funcional', valor: 150.50, formas_de_pagamento: ['pix', 'cartao'], max_parcelamento: 3, solicitar_endereco: false, ativo: true }
  },
  {
    category: 'Carteira',
    name: 'Remover Saldo (Admin)',
    type: 'edge-function',
    method: 'POST',
    endpoint: 'wallet/remove-balance',
    description: 'Remove um valor do saldo de um usu√°rio (Admin)',
    requiresAuth: true,
    priority: 'critical',
    payload: { userId: 'user-id-placeholder', amount: 1, type: 'pix', motivo: 'Ajuste de teste via script' }
  },
  {
    category: 'Carteira',
    name: 'Adicionar Saldo (Admin)',
    type: 'edge-function',
    method: 'POST',
    endpoint: 'wallet/balance-management',
    description: 'Adiciona um valor ao saldo de um usu√°rio (Admin)',
    requiresAuth: true,
    priority: 'critical',
    payload: { userId: 'user-id-placeholder', amount: 1, type: 'pix', motivo: 'Ajuste de teste via script', operation: 'add' }
  },
  
  // ========== M√ìDULOS ADMIN (DETALHES E A√á√ïES) ==========
  {
    category: 'Admin: BaaS',
    name: 'Detalhes do Provedor BaaS',
    type: 'edge-function',
    method: 'GET',
    endpoint: 'baas/baas-id', // Placeholder
    description: 'Busca detalhes de um provedor BaaS',
    requiresAuth: true,
    priority: 'medium'
  },
  {
    category: 'Admin: BaaS',
    name: 'Taxas do Provedor BaaS',
    type: 'edge-function',
    method: 'GET',
    endpoint: 'baas/baas-id/taxas', // Placeholder
    description: 'Busca taxas de um provedor BaaS',
    requiresAuth: true,
    priority: 'medium'
  },
  {
    category: 'Admin: BaaS',
    name: 'Ativar/Desativar Provedor BaaS',
    type: 'edge-function',
    method: 'PATCH',
    endpoint: 'baas/baas-id/active', // Placeholder
    description: 'Ativa ou desativa um provedor BaaS',
    requiresAuth: true,
    priority: 'medium',
    payload: { active: false }
  },
  {
    category: 'Admin: Adquirentes',
    name: 'Detalhes do Adquirente',
    type: 'edge-function',
    method: 'GET',
    endpoint: 'acquirers/acquirer-id', // Placeholder
    description: 'Busca detalhes de um adquirente',
    requiresAuth: true,
    priority: 'medium'
  },
  {
    category: 'Admin: Adquirentes',
    name: 'Taxas do Adquirente',
    type: 'edge-function',
    method: 'GET',
    endpoint: 'acquirers/acquirer-id/taxas', // Placeholder
    description: 'Busca taxas de um adquirente',
    requiresAuth: true,
    priority: 'medium'
  },
  {
    category: 'Admin: Adquirentes',
    name: 'Ativar/Desativar Adquirente',
    type: 'edge-function',
    method: 'PATCH',
    endpoint: 'acquirers/acquirer-id/active', // Placeholder
    description: 'Ativa ou desativa um adquirente',
    requiresAuth: true,
    priority: 'medium',
    payload: { active: false }
  },

  // ========== CALCULADORA ==========
  {
    category: 'Calculadora',
    name: 'Calculadora de Taxas',
    type: 'edge-function',
    method: 'POST',
    endpoint: 'taxas',
    payload: {
      company_id: 'company-id-placeholder',
      valor: 10000,
      payment_method: 'PIX',
      parcelas: 1
    },
    description: 'Calcula as taxas para uma transa√ß√£o',
    requiresAuth: true,
    priority: 'high'
  },
];

// Vari√°veis globais para sess√£o
let userSession = null;
let loggedUser = null;
let firstBaasId = null;
let firstAcquirerId = null;
let userCompanyId = null; // Mantido para o caso de algum endpoint precisar no futuro

// Fun√ß√£o para fazer login real
async function performRealLogin() {
  const startTime = Date.now();
  
  try {
    console.log(`üîê Fazendo login real com ${TEST_CREDENTIALS.email}...`);
    
    const { data, error } = await supabase.auth.signInWithPassword({
      email: TEST_CREDENTIALS.email,
      password: TEST_CREDENTIALS.password,
    });
    
    const duration = Date.now() - startTime;
    
    if (error) {
      throw error;
    }
    
    if (!data.session) {
      throw new Error('Login n√£o retornou uma sess√£o v√°lida');
    }
    
    userSession = data.session;
    loggedUser = data.user;
    
    console.log(`‚úÖ Login realizado com sucesso! (${duration}ms)`);
    console.log(`   üë§ Usu√°rio: ${loggedUser.email}`);
    console.log(`   üîë Token: ${userSession.access_token.substring(0, 30)}...`);
    console.log(`   ‚è∞ Expira em: ${new Date(userSession.expires_at * 1000).toLocaleString()}`);
    
    return { success: true, duration, data: { user: loggedUser, session: userSession } };
    
  } catch (error) {
    const duration = Date.now() - startTime;
    console.log(`‚ùå Erro no login: ${error.message} (${duration}ms)`);
    return { success: false, duration, error: error.message };
  }
}

// Fun√ß√£o para testar endpoint de autentica√ß√£o
async function testAuthEndpoint(test) {
  const startTime = Date.now();
  
  try {
    console.log(`‚è≥ Testando: ${test.name}...`);
    
    let response;
    
    if (test.endpoint === 'signInWithPassword') {
      return await performRealLogin();
    } else if (test.endpoint === 'getUser') {
      response = await supabase.auth.getUser();
    }
    
    const duration = Date.now() - startTime;
    
    if (response.error) {
      throw response.error;
    }
    
    console.log(`‚úÖ ${test.name}: Sucesso (${duration}ms)`);
    if (response.data) {
      const dataStr = JSON.stringify(response.data);
      console.log(`   Dados: ${dataStr.substring(0, 150)}${dataStr.length > 150 ? '...' : ''}`);
    }
    return { success: true, duration, data: response.data };
    
  } catch (error) {
    const duration = Date.now() - startTime;
    console.log(`‚ùå ${test.name}: ${error.message} (${duration}ms)`);
    return { success: false, duration, error: error.message };
  }
}

// Fun√ß√£o para testar Edge Function
async function testEdgeFunction(test, index, total) {
  const startTime = Date.now();
  try {
    let endpoint = test.endpoint;
    let finalPayload = { ...(test.payload || {}) };

    // Para todos os endpoints de Dashboard com m√©todo POST, as datas v√£o na URL.
    if (test.category === 'Dashboard' && test.method === 'POST') {
      const endDate = new Date().toISOString().split('T')[0];
      const startDate = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
      
      endpoint = `${test.endpoint}?start_date=${startDate}&end_date=${endDate}`;
      finalPayload = {}; // Corpo da requisi√ß√£o fica vazio
    }

    // --- Substitui√ß√£o de Placeholders ---
    if (userSession?.user?.id) {
        const userId = userSession.user.id;
        endpoint = endpoint.replace(/user-id-placeholder/g, userId);
        if (finalPayload.userId) {
            finalPayload.userId = userId;
        }
        if (endpoint.includes('extrato/user-id')) {
            endpoint = endpoint.replace('user-id', userId);
        }
    }

    if (userCompanyId) {
        if (finalPayload.company_id) {
            finalPayload.company_id = userCompanyId;
        }
    }

    if (firstBaasId) {
        endpoint = endpoint.replace(/baas-id/g, firstBaasId);
    }
    if (firstAcquirerId) {
        endpoint = endpoint.replace(/acquirer-id/g, firstAcquirerId);
    }
    // --- Fim da Substitui√ß√£o ---

    const invokeOptions = {
        method: test.method,
        body: Object.keys(finalPayload).length > 0 ? finalPayload : undefined,
    };
    
    const response = await supabase.functions.invoke(endpoint, invokeOptions);
    const duration = Date.now() - startTime;
    
    if (response.error) {
      throw response.error;
    }
    
    // Capturar dados din√¢micos para testes subsequentes
    if (test.name === 'Listar Provedores BaaS' && response.data?.success && response.data?.Baas?.length > 0) {
        firstBaasId = response.data.Baas[0].id;
        console.log(`   üè¶ ID do primeiro provedor BaaS capturado: ${firstBaasId}`);
    }
    if (test.name === 'Listar Adquirentes' && response.data?.success && response.data?.acquirers?.length > 0) {
        firstAcquirerId = response.data.acquirers[0].id;
        console.log(`   üí≥ ID do primeiro adquirente capturado: ${firstAcquirerId}`);
    }
    if (test.name === 'Dados da Empresa' && response.data?.success && response.data?.companies?.length > 0) {
        userCompanyId = response.data.companies[0].id;
        console.log(`   üè¢ ID da empresa capturado: ${userCompanyId}`);
    }
    
    console.log(`‚úÖ ${test.name}: Sucesso (${duration}ms)`);
    if (response.data) {
      const dataStr = JSON.stringify(response.data);
      console.log(`   Dados: ${dataStr.substring(0, 200)}${dataStr.length > 200 ? '...' : ''}`);
    }
    return { success: true, duration, data: response.data };
    
  } catch (error) {
    const duration = Date.now() - (error.startTime || startTime);
    const errorMessage = error.message.includes('Function not found') 
      ? `Edge Function '${test.endpoint}' n√£o encontrada. Verifique o nome e se foi deployada.`
      : error.message;
    console.error(`‚ùå ${test.name}: ${errorMessage} (${duration}ms)`);
    return { success: false, test, error: errorMessage, duration };
  }
}

// Fun√ß√£o principal de teste
async function runRealCommunicationTests() {
  console.log('üß™ Executando testes REAIS de comunica√ß√£o (Apenas Endpoints Funcionais)...\\n');
  
  const results = [];
  const categories = {};
  
  // Agrupar por categoria
  functionalEndpoints.forEach(test => {
    if (!categories[test.category]) {
      categories[test.category] = [];
    }
    categories[test.category].push(test);
  });
  
  // Executar testes por categoria
  for (const [category, tests] of Object.entries(categories)) {
    console.log(`\\nüìÅ CATEGORIA: ${category.toUpperCase()}`);
    console.log('='.repeat(60));
    
    for (const test of tests) {
      let result;
      
      if (test.requiresAuth && !userSession && test.endpoint !== 'signInWithPassword') {
        console.log(`‚è≠Ô∏è  Pulando ${test.name} (requer autentica√ß√£o)`);
        continue;
      }
      
      if (test.type === 'auth') {
        result = await testAuthEndpoint(test);
      } else {
        result = await testEdgeFunction(test, tests.indexOf(test), tests.length);
      }
      
      results.push({ 
        test: test.name, 
        category: test.category,
        priority: test.priority,
        ...result 
      });
      
      await new Promise(resolve => setTimeout(resolve, 300)); // Delay menor
    }
  }
  
  // Relat√≥rio final
  console.log('\\nüìä RELAT√ìRIO FINAL (Endpoints Funcionais)');
  console.log('='.repeat(80));
  
  const totalTests = results.length;
  const successCount = results.filter(r => r.success).length;
  const errorCount = results.filter(r => !r.success).length;
  const successRate = totalTests > 0 ? Math.round((successCount / totalTests) * 100) : 100;
  
  console.log(`üìà ESTAT√çSTICAS GERAIS:`);
  console.log(`   Total de testes executados: ${totalTests}`);
  console.log(`   ‚úÖ Sucessos: ${successCount}`);
  console.log(`   ‚ùå Erros: ${errorCount}`);
  console.log(`   üìä Taxa de sucesso: ${successRate}%`);
  
  if (errorCount > 0) {
    console.log('\\n‚ùå ENDPOINTS COM PROBLEMAS (DEVERIAM FUNCIONAR):');
    const errorDetails = results.filter(r => !r.success);

    errorDetails.forEach((result, index) => {
      const testInfo = functionalEndpoints.find(e => e.name === result.test);
      console.log(`   ${index + 1}. ${result.test}`);
      console.log(`      Categoria: ${result.category}`);
      console.log(`      Endpoint: ${testInfo?.method} /${testInfo?.endpoint}`);
      console.log(`      Erro: ${result.error}`);
    });
    console.log('   üö® ATEN√á√ÉO: Endpoints que antes funcionavam agora est√£o falhando. Verifique regress√µes no backend.');
  } else {
    console.log('\\n‚úÖ Todos os 40 endpoints funcionais confirmados com sucesso!');
  }
  
  console.log('\\nüèÅ Teste de comunica√ß√£o real conclu√≠do!');
  
  process.exit(errorCount > 0 ? 1 : 0);
}

// Tratamento de erros globais
process.on('unhandledRejection', (error) => {
  console.error('üí• Erro n√£o tratado:', error);
  process.exit(1);
});

// Executar testes
runRealCommunicationTests().catch(error => {
  console.error('üí• Erro fatal durante os testes:', error);
  process.exit(1);
});